---
import BaseLayout from '../layouts/BaseLayout.astro';
import type { ContactStatus } from '../lib/contact';

type ContactPageStatus = Exclude<ContactStatus, 'success'>;

const statusParam = Astro.url.searchParams.get('status');
const knownStatuses: ContactPageStatus[] = ['invalid', 'captcha', 'error'];
const status = knownStatuses.includes(statusParam as ContactPageStatus)
  ? (statusParam as ContactPageStatus)
  : null;

const statusMessages: Record<ContactPageStatus, string> = {
  invalid: 'Please review the form and provide a valid name, email, and message.',
  captcha: 'CAPTCHA verification failed. Please try again.',
  error: 'Something went wrong while sending your message. Please try again shortly.',
};

const envSiteKey = (import.meta.env.PUBLIC_TURNSTILE_SITE_KEY ?? '').trim();
const turnstileSiteKey =
  envSiteKey || (import.meta.env.DEV ? '1x00000000000000000000AA' : '');
const isCaptchaConfigured = turnstileSiteKey.length > 0;
---

<BaseLayout title="Contact" description="Send a message to Chris Zombik.">
  <article class="contact-page reveal">
    <header class="contact-header">
      <p class="home-eyebrow">Contact</p>
      <h1>Get in touch.</h1>
      <p>
        If you would like to connect about writing, speaking, or consulting work, send a message
        below.
      </p>
    </header>

    {status && (
      <p class:list={['contact-status', `contact-status-${status}`]} role="status" aria-live="polite">
        {statusMessages[status]}
      </p>
    )}

    {!isCaptchaConfigured && (
      <p class:list={['contact-status', 'contact-status-error']} role="alert">
        Contact form configuration is incomplete. Please try again later.
      </p>
    )}

    <form class="contact-form" action="/api/contact" method="POST">
      <div class="contact-field">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" autocomplete="name" required maxlength="100" />
      </div>

      <div class="contact-field">
        <label for="email">Email</label>
        <input
          id="email"
          name="email"
          type="email"
          autocomplete="email"
          inputmode="email"
          required
          maxlength="254"
        />
      </div>

      <div class="contact-field">
        <label for="message">Message</label>
        <textarea id="message" name="message" rows="8" required minlength="10" maxlength="5000" />
      </div>

      <div class="contact-honeypot" aria-hidden="true">
        <label for="company">Company</label>
        <input id="company" name="company" type="text" tabindex="-1" autocomplete="off" />
      </div>

      <div class="contact-turnstile">
        {isCaptchaConfigured ? (
          <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="auto" />
        ) : (
          <p>CAPTCHA is unavailable at the moment.</p>
        )}
      </div>

      <button class="contact-submit" type="submit" disabled={!isCaptchaConfigured}>
        Send message
      </button>
    </form>
  </article>

  {isCaptchaConfigured && (
    <script
      is:inline
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer
    ></script>
  )}
</BaseLayout>
