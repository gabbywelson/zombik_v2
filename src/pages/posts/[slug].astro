---
import RichTextRenderer from '../../components/RichTextRenderer.astro';
import SanityImage from '../../components/SanityImage.astro';
import TagList from '../../components/TagList.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPostBySlug, getPostSlugs } from '../../lib/content';
import { formatDate } from '../../lib/format';

export async function getStaticPaths() {
  const slugs = await getPostSlugs();

  return slugs.map((slug) => ({
    params: { slug },
  }));
}

const slug = Astro.params.slug ?? '';
const post = await getPostBySlug(slug);

if (!post) {
  throw new Error(`Post not found for slug: ${slug}`);
}
---

<BaseLayout
  title={post.title}
  description={post.excerpt}
  socialImage={post.heroImage}
  socialImageAlt={post.heroImage?.alt ?? post.title}
>
  <article class="post-page reveal">
    <header class="post-header">
      <p class="post-meta">
        <span>{formatDate(post.publishedAt)}</span>
      </p>

      <h1>{post.title}</h1>
      <p class="post-excerpt">{post.excerpt}</p>
      <TagList tags={post.tags} hrefBase="/posts" />

      <SanityImage
        image={post.heroImage}
        alt={post.heroImage?.alt ?? post.title}
        class="post-hero"
        loading="eager"
      />
    </header>

    <RichTextRenderer value={post.body} footnotePrefix={`post-${post.slug}`} />
  </article>
</BaseLayout>
