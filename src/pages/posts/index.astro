---
import PostCard from '../../components/PostCard.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPostIndexData } from '../../lib/content';

const posts = await getPostIndexData();

const tagsBySlug = new Map<string, { title: string; slug: string; count: number }>();

for (const post of posts) {
  for (const tag of post.tags ?? []) {
    const current = tagsBySlug.get(tag.slug);

    if (current) {
      current.count += 1;
    } else {
      tagsBySlug.set(tag.slug, { title: tag.title, slug: tag.slug, count: 1 });
    }
  }
}

const tags = Array.from(tagsBySlug.values()).sort((a, b) => a.title.localeCompare(b.title));
---

<BaseLayout title="Posts" description="Blog posts by Chris Zombik.">
  <section class="writing-page reveal">
    <header class="writing-header">
      <p class="home-eyebrow">Posts</p>
      <h1>Blog posts and notes.</h1>
      <p class="posts-rss-link">
        <a href="/rss.xml" class="section-link">RSS feed</a>
      </p>
    </header>

    {tags.length > 0 && (
      <nav class="tag-filter-nav" aria-label="Browse posts by tag">
        <a href="#all-posts">All</a>
        {tags.map((tag) => (
          <a href={`#tag-${tag.slug}`}>
            {tag.title} <span>({tag.count})</span>
          </a>
        ))}
      </nav>
    )}

    <section id="all-posts" class="writing-group">
      <h2>All Posts</h2>
      {posts.length === 0 ? (
        <p>No posts published yet.</p>
      ) : (
        <div class="post-grid">
          {posts.map((post) => (
            <PostCard post={post} hrefPrefix="/posts" />
          ))}
        </div>
      )}
    </section>

    {tags.map((tag) => {
      const taggedPosts = posts.filter((post) =>
        (post.tags ?? []).some((item) => item.slug === tag.slug),
      );

      return (
        <section id={`tag-${tag.slug}`} class="writing-group">
          <h2>{tag.title}</h2>
          <div class="post-grid">
            {taggedPosts.map((post) => (
              <PostCard post={post} hrefPrefix="/posts" />
            ))}
          </div>
        </section>
      );
    })}
  </section>
</BaseLayout>
