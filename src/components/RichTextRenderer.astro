---
import { escapeHTML, toHTML, uriLooksSafe } from '@portabletext/to-html';
import { collectFootnotes } from '../lib/footnotes';
import type { PortableTextBlock } from '../lib/sanity.types';

interface Props {
  value?: PortableTextBlock[];
  class?: string;
  footnotePrefix?: string;
  includeFootnotes?: boolean;
}

const {
  value = [],
  class: className = '',
  footnotePrefix = 'footnote',
  includeFootnotes = true,
} = Astro.props;

const { items, byMarkKey } = collectFootnotes(value, footnotePrefix);
const referenceCounts = new Map<string, number>();

const linkMark = ({
  children,
  value: markValue,
}: {
  children: string;
  value?: { href?: string; blank?: boolean };
}) => {
  const href = markValue?.href ?? '';
  if (!uriLooksSafe(href)) {
    return children;
  }

  const rel = markValue?.blank ? 'noreferrer noopener' : undefined;
  const target = markValue?.blank ? '_blank' : undefined;
  const relAttr = rel ? ` rel="${escapeHTML(rel)}"` : '';
  const targetAttr = target ? ` target="${escapeHTML(target)}"` : '';

  return `<a href="${escapeHTML(href)}"${targetAttr}${relAttr}>${children}</a>`;
};

const bodyHtml = toHTML(value, {
  components: {
    block: {
      normal: ({ children }) => `<p>${children}</p>`,
      h2: ({ children }) => `<h2>${children}</h2>`,
      h3: ({ children }) => `<h3>${children}</h3>`,
      blockquote: ({ children }) => `<blockquote>${children}</blockquote>`,
      indent: ({ children }) => `<p class="rt-indent">${children}</p>`,
    },
    marks: {
      code: ({ children }) => `<code>${children}</code>`,
      link: linkMark,
      footnote: ({ children, markKey }) => {
        const footnote = markKey ? byMarkKey[markKey] : undefined;

        if (!footnote) {
          return children;
        }

        const nextReferenceCount = (referenceCounts.get(footnote.key) ?? 0) + 1;
        referenceCounts.set(footnote.key, nextReferenceCount);

        const referenceId =
          nextReferenceCount === 1
            ? footnote.refId
            : `${footnote.refId}-${nextReferenceCount}`;

        return `${children}<sup class="footnote-ref"><a id="${referenceId}" href="#${footnote.noteId}" aria-label="Footnote ${footnote.number}">${footnote.number}</a></sup>`;
      },
    },
  },
  onMissingComponent: false,
});

const endnotesHtml = items
  .map((footnote) => {
    const noteHtml = toHTML(footnote.note, {
      components: {
        block: {
          normal: ({ children }) => `<p>${children}</p>`,
          h2: ({ children }) => `<h2>${children}</h2>`,
          h3: ({ children }) => `<h3>${children}</h3>`,
          blockquote: ({ children }) => `<blockquote>${children}</blockquote>`,
          indent: ({ children }) => `<p class="rt-indent">${children}</p>`,
        },
        marks: {
          code: ({ children }) => `<code>${children}</code>`,
          link: linkMark,
        },
      },
      onMissingComponent: false,
    });

    return `<li id="${footnote.noteId}" class="endnote-item"><div class="endnote-copy">${noteHtml}</div><a class="endnote-backlink" href="#${footnote.refId}" aria-label="Back to reference ${footnote.number}">â†©</a></li>`;
  })
  .join('');
---

<div class:list={['rich-text', className]} set:html={bodyHtml} />

{includeFootnotes && items.length > 0 && (
  <section class="endnotes" aria-labelledby="endnotes-heading">
    <h2 id="endnotes-heading">Notes</h2>
    <ol set:html={endnotesHtml} />
  </section>
)}
